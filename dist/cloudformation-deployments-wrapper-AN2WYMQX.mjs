import{a as A}from"./chunk-5PARVRO5.mjs";import{a as E,b as I,c as b,d as h,e as N,f,h as p}from"./chunk-EDST2GNR.mjs";import"./chunk-3PEVV4HI.mjs";import"./chunk-R6PYGTER.mjs";import"./chunk-SUBS3TDM.mjs";import{c as w}from"./chunk-ISPMX3VH.mjs";import"./chunk-THC7OU5T.mjs";import{e as c}from"./chunk-7S7IXY6P.mjs";var P=c(w(),1),o=c(E(),1),y=c(I(),1),S=c(b(),1),g=c(h(),1),T=c(N(),1);async function D(a,e){let{deployment:r,toolkitInfo:s,stackSdk:t,resolvedEnvironment:l,cloudFormationRoleArn:m}=await M().get(a,e);return await r.publishStackAssets(e.stack,s,{buildAssets:e.buildAssets??!0,publishOptions:{quiet:e.quiet,parallel:e.assetParallelism}}),F({stack:e.stack,noMonitor:!0,resolvedEnvironment:l,deployName:e.deployName,notificationArns:e.notificationArns,quiet:e.quiet,sdk:t,sdkProvider:a,roleArn:m,reuseAssets:e.reuseAssets,toolkitInfo:s,tags:e.tags,deploymentMethod:e.deploymentMethod,force:e.force,parameters:e.parameters,usePreviousParameters:e.usePreviousParameters,progress:e.progress,ci:e.ci,rollback:e.rollback,hotswap:e.hotswap,extraUserAgent:e.extraUserAgent,resourcesToImport:e.resourcesToImport,overrideTemplate:e.overrideTemplate,assetParallelism:e.assetParallelism})}var M=A.memo(()=>{let a=new Map;return{async get(e,r){let s=r.stack.environment.region;if(!a.has(s)){let t=new p({sdkProvider:e}),{stackSdk:l,resolvedEnvironment:m,cloudFormationRoleArn:n}=await t.prepareSdkFor(r.stack,r.roleArn),i=await y.ToolkitInfo.lookup(m,l,r.toolkitStackName);await t.validateBootstrapStackVersion(r.stack.stackName,r.stack.requiresBootstrapStackVersion,r.stack.bootstrapStackVersionSsmParameter,i),a.set(s,{deployment:t,toolkitInfo:i,stackSdk:l,resolvedEnvironment:m,cloudFormationRoleArn:n})}return a.get(s)}}});async function F(a){let e=a.stack,r=a.resolvedEnvironment;a.sdk.appendCustomUserAgent(a.extraUserAgent);let s=a.sdk.cloudFormation(),t=a.deployName||e.stackName,l=await o.CloudFormationStack.lookup(s,t);if(l.stackStatus.isCreationFailure){(0,P.debug)(`Found existing stack ${t} that had previously failed creation. Deleting it before attempting to re-create it.`),await s.deleteStack({StackName:t}).promise();let d=await(0,o.waitForStackDelete)(s,t);if(d&&d.stackStatus.name!=="DELETE_COMPLETE")throw new Error(`Failed deleting stack ${t} that had previously failed creation (current state: ${d.stackStatus})`);l=o.CloudFormationStack.doesNotExist(s,t)}let m=new T.AssetManifestBuilder,n=await(0,S.addMetadataAssetsToManifest)(e,m,a.toolkitInfo,a.reuseAssets),i={...a.parameters,...n},u=o.TemplateParameters.fromTemplate(e.template),v=a.usePreviousParameters?u.updateExisting(i,l.parameters):u.supplyAll(i),k=await f(e,a.resolvedEnvironment,m,a.toolkitInfo,a.sdk,a.overrideTemplate);return await(0,g.publishAssets)(m.toManifest(e.assembly.directory),a.sdkProvider,r,{parallel:a.assetParallelism}),{isUpdate:l.exists&&l.stackStatus.name!=="REVIEW_IN_PROGRESS",params:{StackName:t,TemplateBody:k.TemplateBody,TemplateURL:k.TemplateURL,Parameters:v.apiParameters,Capabilities:["CAPABILITY_IAM","CAPABILITY_NAMED_IAM","CAPABILITY_AUTO_EXPAND"],Tags:a.tags}}}export{D as publishDeployAssets};
