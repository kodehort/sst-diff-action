import{b as w,f as u,v as h,w as g,x as y,y as m}from"./chunk-PT6L7NJD.mjs";import"./chunk-7H2TFXPN.mjs";import"./chunk-IQOVF5LO.mjs";import{a as p}from"./chunk-5PARVRO5.mjs";import"./chunk-3PEVV4HI.mjs";import"./chunk-R6PYGTER.mjs";import"./chunk-SUBS3TDM.mjs";import"./chunk-KU6QELUJ.mjs";import"./chunk-ISPMX3VH.mjs";import"./chunk-THC7OU5T.mjs";import"./chunk-7S7IXY6P.mjs";import n from"path";import x from"fs/promises";import v from"os";import{spawn as I}from"child_process";var H=p.memo(async()=>{let e=await y(),a=await g(),k=h(),i=new Map,d=new Map,f=process.platform==="win32"?"bootstrap.exe":"bootstrap";k.register({shouldBuild:r=>{let o=d.get(r.functionID);return o?u(o,r.file):!1},canHandle:r=>r.startsWith("go"),startWorker:async r=>{let o=I(n.join(r.out,f),{env:{...process.env,...r.environment,IS_LOCAL:"true",AWS_LAMBDA_RUNTIME_API:`localhost:${a.port}/${r.workerID}`},cwd:r.out});o.on("exit",()=>e.exited(r.workerID)),o.stdout.on("data",t=>{e.stdout(r.workerID,t.toString())}),o.stderr.on("data",t=>{e.stdout(r.workerID,t.toString())}),i.set(r.workerID,o)},stopWorker:async r=>{let o=i.get(r);o&&(o.kill(),i.delete(r))},build:async r=>{let o=n.parse(r.props.handler),t=await A(o.dir,"go.mod");d.set(r.functionID,t);let c=n.relative(t,r.props.handler);if(r.mode==="start")try{let s=n.join(r.out,f),l=v.platform()==="win32"?c.replaceAll("\\","\\\\"):c,b=await m(`go build -ldflags "-s -w" -o "${s}" ./${l}`,{cwd:t,env:{...process.env}})}catch(s){return{type:"error",errors:[String(s)]}}if(r.mode==="deploy")try{let s=n.join(r.out,"bootstrap"),l=v.platform()==="win32"?c.replaceAll("\\","\\\\"):c;await m(`go build -ldflags "-s -w" -o "${s}" ./${l}`,{cwd:t,env:{...process.env,CGO_ENABLED:"0",GOARCH:r.props.architecture==="arm_64"?"arm64":"amd64",GOOS:"linux"}})}catch(s){return{type:"error",errors:[String(s)]}}return{type:"success",handler:"bootstrap"}}})});async function A(e,a){if(e==="/")throw new w(`Could not find a ${a} file`);return await x.access(n.join(e,a)).then(()=>!0).catch(()=>!1)?e:A(n.join(e,".."),a)}export{H as useGoHandler};
