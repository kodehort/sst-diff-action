import{d as w,f as x,v as D,w as S,x as P}from"./chunk-PT6L7NJD.mjs";import"./chunk-7H2TFXPN.mjs";import{K as k,z as I}from"./chunk-IQOVF5LO.mjs";import{a as g}from"./chunk-5PARVRO5.mjs";import"./chunk-3PEVV4HI.mjs";import"./chunk-R6PYGTER.mjs";import"./chunk-SUBS3TDM.mjs";import"./chunk-KU6QELUJ.mjs";import"./chunk-ISPMX3VH.mjs";import"./chunk-THC7OU5T.mjs";import{e as _}from"./chunk-7S7IXY6P.mjs";import l from"path";import{exec as j,spawn as M}from"child_process";import{promisify as T}from"util";var u=_(I(),1);var h=_(k(),1);import d from"fs";import C from"url";import m from"path";var A=m.dirname(C.fileURLToPath(import.meta.url));var N="/var/dependencies";function E(t){let{entry:i,runtime:c,outputPathSuffix:n,installCommands:a}=t,s=h.FileSystem.mkdtemp("python-bundling-"),e=v(i,s),o=R(a||[],s),r=o?"Dockerfile.custom":e?"Dockerfile.dependencies":"Dockerfile";d.copyFileSync(m.join(A,"../../support/python-runtime",r),m.join(s,r));let f=h.DockerImage.fromBuild(s,{buildArgs:{IMAGE:c.bundlingImage.image},file:r}),p=m.join(t.out,n);(e||o)&&f.cp(`${N}/.`,p),d.cpSync(i,p,{recursive:!0})}function v(t,i){let c=["Pipfile","pyproject","poetry","requirements.txt"],n=!1;for(let a of d.readdirSync(t))for(let s of c)a.startsWith(s)&&(d.copyFileSync(m.join(t,a),m.join(i,a)),n=!0);return n}function R(t,i){let c=!1;if(t.length>0){let n=m.join(i,"sst-deps-install-command.sh");d.writeFileSync(n,t.join(" && ")),d.chmodSync(n,"755"),c=!0}return c}import H from"os";import L from"url";var K=T(j),b={"python2.7":u.Runtime.PYTHON_2_7,"python3.6":u.Runtime.PYTHON_3_6,"python3.7":u.Runtime.PYTHON_3_7,"python3.8":u.Runtime.PYTHON_3_8,"python3.9":u.Runtime.PYTHON_3_9},ee=g.memo(async()=>{let t=await P(),i=await S(),c=D(),n=new Map,a=new Map;async function s(e){let o=["requirements.txt","Pipfile","poetry.lock"];for(let r of o){let f=await w(e,r);if(f)return f}}c.register({shouldBuild:e=>{let o=a.get(e.functionID);return o?x(o,e.file):!1},canHandle:e=>e.startsWith("python"),startWorker:async e=>{let o=await s(e.handler);if(!o)throw new Error(`Could not find src for ${e.handler}`);let r=l.parse(l.relative(o,e.handler)),f=[...r.dir.split(l.sep),r.name].join("."),p=M(H.platform()==="win32"?"python.exe":"python3",["-u",L.fileURLToPath(new URL("../../support/python-runtime/runtime.py",import.meta.url)),f,o,r.ext.substring(1)],{env:{...process.env,...e.environment,IS_LOCAL:"true",AWS_LAMBDA_FUNCTION_MEMORY_SIZE:"1024",AWS_LAMBDA_RUNTIME_API:`localhost:${i.port}/${e.workerID}`},shell:!0,cwd:o});p.on("exit",()=>t.exited(e.workerID)),p.stdout.on("data",y=>{t.stdout(e.workerID,y.toString())}),p.stderr.on("data",y=>{t.stdout(e.workerID,y.toString())}),n.set(e.workerID,p)},stopWorker:async e=>{let o=n.get(e);o&&(o.kill(),n.delete(e))},build:async e=>{var r;if(e.mode==="start")return{type:"success",handler:e.props.handler};let o=await s(e.props.handler);return o?(E({installCommands:(r=e.props.python)==null?void 0:r.installCommands,entry:o,runtime:b[e.props.runtime],outputPathSuffix:".",out:e.out}),{type:"success",handler:l.relative(o,l.resolve(e.props.handler)).split(l.sep).join(l.posix.sep)}):{type:"error",errors:[`Could not find src for ${e.props.handler}`]}}})});export{ee as usePythonHandler};
